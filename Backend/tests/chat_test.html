<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat API 测试页面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* 流式文本动画 */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .typing-cursor::after {
            content: '▊';
            animation: blink 1s infinite;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h1 class="text-2xl font-bold text-slate-900 mb-2">Chat API 测试页面</h1>
            <p class="text-slate-600 text-sm">测试智能对话接口，支持文字和多图片上传</p>
            
            <!-- 配置区域 -->
            <div class="mt-4 p-4 bg-slate-50 rounded-lg border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">API 地址</label>
                        <input 
                            type="text" 
                            id="apiUrl" 
                            value="http://localhost:8000" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Token (alice123)</label>
                        <input 
                            type="text" 
                            id="token" 
                            value="alice123" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="streamMode" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-slate-700">流式响应 (SSE)</span>
                    </label>
                    <button 
                        onclick="clearChat()" 
                        class="px-3 py-1 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded transition-colors duration-200 cursor-pointer"
                    >
                        清除对话
                    </button>
                </div>
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col" style="height: 600px;">
            <!-- 消息列表 -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4">
                <div class="text-center text-slate-400 text-sm py-8">
                    开始对话...
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="border-t border-gray-200 p-4">
                <!-- 文件上传 -->
                <div class="mb-3">
                    <label class="block text-sm font-medium text-slate-700 mb-2">上传图片（支持多选）</label>
                    <div class="flex items-center gap-2">
                        <input 
                            type="file" 
                            id="fileInput" 
                            multiple 
                            accept="image/*" 
                            class="hidden"
                            onchange="handleFileSelect(event)"
                        />
                        <button 
                            onclick="document.getElementById('fileInput').click()" 
                            class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md text-sm font-medium transition-colors duration-200 cursor-pointer"
                        >
                            选择图片
                        </button>
                        <div id="fileList" class="flex-1 flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- 文本输入 -->
                <div class="flex gap-2">
                    <textarea 
                        id="messageInput" 
                        placeholder="输入消息..." 
                        rows="2"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button 
                        onclick="sendMessage()" 
                        id="sendBtn"
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition-colors duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        发送
                    </button>
                </div>
            </div>
        </div>

        <!-- 状态栏 -->
        <div id="statusBar" class="mt-4 text-sm text-slate-500 text-center"></div>
    </div>

    <script>
        let sessionId = null;
        let selectedFiles = [];

        // 处理文件选择
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = files;
            updateFileList();
        }

        // 更新文件列表显示
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center gap-2 px-3 py-1 bg-blue-50 text-blue-700 rounded-md text-sm';
                fileItem.innerHTML = `
                    <span>${file.name}</span>
                    <button 
                        onclick="removeFile(${index})" 
                        class="text-blue-600 hover:text-blue-800 cursor-pointer"
                    >×</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        // 移除文件
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            // 更新 input 元素
            const input = document.getElementById('fileInput');
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
        }

        // 处理键盘事件
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 发送消息
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            const streamMode = document.getElementById('streamMode').checked;

            if (!message.trim() && selectedFiles.length === 0) {
                alert('请输入消息或选择图片');
                return;
            }

            // 禁用发送按钮
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '发送中...';

            // 保存文件引用（在清空前）
            const filesToProcess = [...selectedFiles];
            const hasFiles = filesToProcess.length > 0;

            // 添加用户消息
            addMessage('user', message, hasFiles ? `${filesToProcess.length} 张图片` : null);

            // 清空输入
            messageInput.value = '';
            selectedFiles = [];
            updateFileList();
            document.getElementById('fileInput').value = '';

            try {
                // 转换图片为 base64
                const imagesBase64 = [];
                for (const file of filesToProcess) {
                    const base64 = await fileToBase64(file);
                    imagesBase64.push(base64);
                }

                // 构建请求体
                const requestBody = {
                    message: message || '请分析这些图片',
                    session_id: sessionId,
                };

                if (imagesBase64.length > 0) {
                    if (imagesBase64.length === 1) {
                        requestBody.image_base64 = imagesBase64[0];
                    } else {
                        requestBody.images_base64 = imagesBase64;
                    }
                }

                if (streamMode) {
                    // 流式响应
                    await sendStreamRequest(apiUrl, token, requestBody);
                } else {
                    // 非流式响应
                    await sendNormalRequest(apiUrl, token, requestBody);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('error', `错误: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
            }
        }

        // 文件转 base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // 移除 data:image/...;base64, 前缀，只保留 base64 数据
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 发送流式请求
        async function sendStreamRequest(apiUrl, token, requestBody) {
            const response = await fetch(`${apiUrl}/api/chat?stream=true`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullResponse = '';
            let intent = '';
            let messageElement = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // 保留最后一个不完整的行

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            
                            switch (data.type) {
                                case 'status':
                                    updateStatus(data.message);
                                    break;
                                case 'intent':
                                    intent = data.intent;
                                    updateStatus(`意图: ${intent}`);
                                    if (!messageElement) {
                                        messageElement = addMessage('assistant', '', null, true);
                                    }
                                    break;
                                case 'token':
                                    fullResponse += data.token;
                                    if (messageElement) {
                                        messageElement.querySelector('.message-content').textContent = fullResponse;
                                        messageElement.querySelector('.message-content').classList.add('typing-cursor');
                                    }
                                    break;
                                case 'action':
                                    if (data.action_result) {
                                        addMessage('system', `操作结果: ${JSON.stringify(data.action_result, null, 2)}`);
                                    }
                                    break;
                                case 'done':
                                    if (messageElement) {
                                        messageElement.querySelector('.message-content').classList.remove('typing-cursor');
                                    }
                                    if (data.session_id) {
                                        sessionId = data.session_id;
                                    }
                                    updateStatus('完成');
                                    break;
                                case 'error':
                                    addMessage('error', `错误: ${data.error}`);
                                    updateStatus('错误');
                                    break;
                            }
                        } catch (e) {
                            console.error('Parse error:', e, line);
                        }
                    }
                }
            }

            // 移除光标动画
            if (messageElement) {
                messageElement.querySelector('.message-content').classList.remove('typing-cursor');
            }
        }

        // 发送普通请求
        async function sendNormalRequest(apiUrl, token, requestBody) {
            updateStatus('发送中...');

            const response = await fetch(`${apiUrl}/api/chat`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            
            addMessage('assistant', data.message, null);
            if (data.intent) {
                updateStatus(`意图: ${data.intent}`);
            }
            if (data.action_result) {
                addMessage('system', `操作结果: ${JSON.stringify(data.action_result, null, 2)}`);
            }
            if (data.session_id) {
                sessionId = data.session_id;
            }
            updateStatus('完成');
        }

        // 添加消息
        function addMessage(role, content, imageInfo = null, isStreaming = false) {
            const messagesDiv = document.getElementById('messages');
            
            // 移除"开始对话"提示
            const emptyMsg = messagesDiv.querySelector('.text-center');
            if (emptyMsg) {
                emptyMsg.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            let bgColor = 'bg-blue-50';
            let textColor = 'text-blue-900';
            if (role === 'user') {
                bgColor = 'bg-blue-600';
                textColor = 'text-white';
            } else if (role === 'error') {
                bgColor = 'bg-red-50';
                textColor = 'text-red-900';
            } else if (role === 'system') {
                bgColor = 'bg-yellow-50';
                textColor = 'text-yellow-900';
            }

            // 使用 SVG 图标而不是 emoji
            const imageIcon = imageInfo ? `
                <div class="text-xs opacity-75 mb-1 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>${imageInfo}</span>
                </div>
            ` : '';
            
            messageDiv.innerHTML = `
                <div class="max-w-[80%] ${bgColor} ${textColor} rounded-lg px-4 py-2 shadow-sm">
                    ${imageIcon}
                    <div class="message-content whitespace-pre-wrap">${escapeHtml(content)}</div>
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });

            return messageDiv;
        }

        // HTML 转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 更新状态
        function updateStatus(status) {
            document.getElementById('statusBar').textContent = status;
        }

        // 清除对话
        async function clearChat() {
            if (!sessionId) {
                alert('没有活动会话');
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();

            try {
                const response = await fetch(`${apiUrl}/api/chat/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                if (response.ok) {
                    sessionId = null;
                    document.getElementById('messages').innerHTML = `
                        <div class="text-center text-slate-400 text-sm py-8">
                            对话已清除
                        </div>
                    `;
                    updateStatus('对话已清除');
                } else {
                    alert('清除失败');
                }
            } catch (error) {
                alert(`错误: ${error.message}`);
            }
        }
    </script>
</body>
</html>
